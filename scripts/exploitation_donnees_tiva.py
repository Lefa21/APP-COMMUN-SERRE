import serial
import time
import requests 

# --- Configuration ---
SERIAL_PORT = 'COM3'
BAUD_RATE = 9600
API_URL = 'http://localhost/APP-COMMUN-SERRE/?controller=api&action=addSensorData'
API_KEY = 'serre_admin_master_key' 
HUMIDITY_SENSOR_ID = 2 # L'ID de votre capteur d'humidité dans la table 'capteurs'

print(f"--- Démarrage du service de lecture sur {SERIAL_PORT} ---")
print(f"Envoi des données vers : {API_URL}")
print("Appuyez sur Ctrl+C pour arrêter le service.")

# Essayer de se connecter au port série
try:
    ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=2)
except serial.SerialException as e:
    print(f"❌ Erreur: Impossible d'ouvrir le port série {SERIAL_PORT}.")
    print(f"Détails: {e}")
    exit()

# Boucle infinie pour lire et envoyer les données en continu
while True:
    try:
        # Lire une ligne depuis le port série
        line = ser.readline().decode('utf-8').strip()

        # Si une ligne a été lue
        if line:
            print(f"[DATA REÇU] '{line}'")
            
            # --- MODIFICATION PRINCIPALE ICI ---
            try:
                # 1. On sépare la chaîne en utilisant le point-virgule comme délimiteur
                parts = line.split(';')
                
                # 2. On vérifie qu'on a bien deux parties
                if len(parts) == 2:
                    # 3. On prend la deuxième partie (l'humidité) et on enlève les espaces
                    humidity_value_str = parts[1].strip()
                    
                    # 4. On convertit cette partie en nombre
                    value = float(humidity_value_str)

                    # Préparer les données à envoyer à l'API
                    payload = {
                        'sensor_id': HUMIDITY_SENSOR_ID,
                        'value': value,
                        'api_key': API_KEY 
                    }

                    # Envoyer les données via une requête POST à votre site PHP
                    try:
                        response = requests.post(API_URL, data=payload, timeout=5)
                        if response.status_code == 200 and response.json().get('success'):
                            print(f"✅ Succès : Humidité ({value}) envoyée au serveur.")
                        else:
                            print(f"⚠️ Échec de l'envoi. Statut: {response.status_code}, Réponse: {response.text}")
                    except requests.exceptions.RequestException as e:
                        print(f"❌ Erreur réseau : Impossible de contacter le serveur. {e}")

                else:
                    print(f"INFO : Format de donnée ignoré (attendu 'bouton;humidité').")
            
            except (ValueError, IndexError):
                # Gère les cas où la deuxième partie n'est pas un nombre ou est absente
                print(f"INFO : Donnée ignorée (impossible d'extraire la valeur d'humidité).")
        
        # Petite pause pour ne pas surcharger le processeur
        time.sleep(1)

    except KeyboardInterrupt:
        print("\nArrêt du service.")
        break
    except Exception as e:
        print(f"Une erreur inattendue est survenue : {e}")
        time.sleep(5)

ser.close()